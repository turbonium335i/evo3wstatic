<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S1 Verification</title>
    <link rel="shortcut icon" type="image/png" href="https://i.postimg.cc/wvJXZq2d/wavelogo.jpg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <script type="text/javascript">
        var user = '{{request.user}}'
        var userid = '{{request.user.id}}'
        <!--        console.log('user:', user, userid)-->
        function getToken(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getToken('csrftoken');
        function getCookie(name) {
            var cookieArr = document.cookie.split(";");
            for (var i = 0; i < cookieArr.length; i++) {
                var cookiePair = cookieArr[i].split("=");
                if (name == cookiePair[0].trim()) {
                    return decodeURIComponent(cookiePair[1]);
                }
            }
            return null;
        }

< !--nyc image-- >
< !--https://i.postimg.cc/k50qSkPV/pexels-ramil-ugot-5011944.jpg-->




    </script>

</head>

<body class="bg-dark text-light d-flex flex-column min-vh-100">

    <div class="container" id="mainDiv">


        <h4 id="testName" class="text-center text-warning  mt-5">wavepoint General English Proficieny Test </h4>
        <br>
        <div class="d-flex justify-content-start   pe-4 mb-3">
            <h3>
                <span class="text-light"> Directions &nbsp;
                </span>
            </h3>

        </div>
        <div class="progress bg-dark" style="height: 2px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: 1%;" aria-valuenow="25"
                aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        <br>


        <div class="ms-3">
            <p>
                The questions in this section address a number of important reading and writing skills. Each question
                includes one
                or more texts, which may include a table or a graph. Read each text and question carefully, then choose
                the
                best answer
                to the question based on the text(s).


            </p>

            <p> All questions in this section are multiple-choice with four answer choices. Each question has a single
                best
                answer.
            </p>
            <br>
            <li>Mobile phones, smartwatches, fitness trackers, or other wearable technology (simple nondigital watches
                are
                acceptable)
            </li>
            <li>Separate timers of any type</li>
            <li>Cameras or any other photographic equipment</li>
            <li>Unacceptable calculators that have QWERTY (computer-like) keypads, use paper tape, make noise, or use a
                power cord
            </li>
        </div>

        <div class="text-center py-5" id="linkDiv">

            <button class="btn btn-secondary btn-lg d-none" id="startBtn" onclick="hideMainDiv()">Start Test <i
                    class="bi bi-arrow-right-circle"></i></button>
        </div>


        <br>


        <div id="jsData" class="text-success"></div>

    </div>

    <div class="container px-lg-5  d-none" id="testDiv">
        <div class="text-center m-3">
            <h5 class="text-light">Verification Test / Correct: <span class="text-success" id="noCorrect">0</span></h5>
        </div>
        <div class="d-flex justify-content-end ">

            <span class="text-light" onclick="timerFunction()" style="cursor: pointer;">
                <i class="bi bi-clock-history text-danger timerOn" id="timer"></i> &nbsp;
            </span>

            <span id="demo">00h 00m 00s </span>
        </div>




        <div class="progress bg-secondary" style="height: 2px;">
            <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="25" aria-valuemin="0"
                aria-valuemax="100"></div>
        </div>
        <br>
        <div class="h5 text-end" id="qCount">Question 1/10</div>
        <div class="container   rounded my-3 p-1 ps-2 pb-5  h5 " id="question">
            Along the highway <u>is</u> a dog and a cat.
        </div>
        <div class=" border border-secondary rounded mb-2 mx-lg-5 py-2 ps-2" id="a" style="cursor:pointer;">A. This is a
            NO CHANGE.</div>
        <div class=" border border-secondary rounded mb-2 mx-lg-5 py-2 ps-2" id="b" style="cursor:pointer;">B. is</div>
        <div class=" border border-secondary rounded mb-2 mx-lg-5 py-2 ps-2" id="c" style="cursor:pointer;">C. are</div>
        <div class=" border border-secondary rounded mb-2 mx-lg-5 py-2 ps-2" id="d" style="cursor:pointer;">D. was</div>
        <div class="text-end mx-lg-5 my-4 ">
            <button type="button" class="btn btn-outline-secondary float-start " id="read">
                <i class="bi bi-soundwave"></i></button>
            <button type="button" class="btn btn-outline-primary  " id="next">Next <i
                    class="bi bi-arrow-right-circle"></i></button>
            <br>
        </div>
        <div class="container d-none" id="solution"></div>
    </div>
    <div id="grammarbox" class="container my-5">gbox</div>

    <!-- add d-none to result box below -->
    <div id="resultbox" class="container my-5 d-none ">

        <div class="text-warning h2 text-center mb-5" id="resultBox">
        </div>
        <br>

        General English Proficieny
        <div class="progress bg-dark border border-success mb-3 rounded-0 mt-1" style="height: 50px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="25"
                aria-valuemin="0" aria-valuemax="100"><span id="resultpercentagetext">0%</span></div>
        </div>
        <br>
        <br>
        Grammar: <span class="text-warning" id="grammarResult"></span>
        <div class="progress bg-secondary    mb-3 rounded-0 mt-1" style="height: 2px;">
            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuenow="25"
                aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        Word in Context: <span class="text-warning" id="contextResult"></span>
        <div class="progress bg-secondary     mb-3 rounded-0 mt-1" style="height: 2px;">
            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuenow="25"
                aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        Idiom: <span class="text-warning" id="idiomResult"></span>
        <div class="progress bg-secondary     mb-3 rounded-0 mt-1" style="height: 2px;">
            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuenow="25"
                aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="text-center my-5">
            <a href="{% url 'dashcandidate' %}" class="btn btn-outline-light btn-lg mt-5"><i
                    class="bi bi-arrow-left-circle"></i> Home
            </a>
        </div>

    </div>

</body>


<script>
    var progressPercentage = 0;
    var x = setInterval(function () {
        document
            .getElementsByClassName("progress-bar")[0]
            .setAttribute("style", "width:" + progressPercentage + "%");
        progressPercentage += 5;
        if (progressPercentage >= 80 || progressPercentage == 100) {
            clearInterval(x);
        }
    }, 100);

    // setTimeout(function () {
    //   document
    //     .getElementsByClassName("progress-bar")[0]
    //     .setAttribute("style", "width:" + 100 + "%");

    //   document.getElementById("jsData").innerHTML = "Test is ready. Good Luck!";
    //   document
    //     .getElementById("startBtn")
    //     .classList.remove("d-none", "btn-secondary");
    //   document.getElementById("startBtn").classList.add("btn-outline-warning");
    // }, 2000);

    function hideMainDiv() {
        document.getElementById("mainDiv").classList.add("d-none");
        document.getElementById("testDiv").classList.remove("d-none");
        startime();
        lvlsend(1, "started");
    }

    var myVar;
    var timeLeft = 901000;
    var countDownDate;

    function startTimer() {
        var now = new Date().getTime();
        var distance = countDownDate - now;
        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((distance % (1000 * 60)) / 1000);
        if (hours < 10) {
            hours = "0" + hours;
        }
        if (minutes < 10) {
            minutes = "0" + minutes;
        }
        if (seconds < 10) {
            seconds = "0" + seconds;
        }
        document.getElementById("demo").innerHTML =
            hours + "h " + minutes + "m " + seconds + "s ";
        if (distance < 0) {
            clearInterval(countDownDate);
            clearInterval(myVar);
            document.getElementById("demo").innerHTML = "TIME'S UP";
            // document.getElementById("testDiv").classList.add("d-none");
            // document.getElementById("resultbox").classList.remove("d-none");
            showResults();
        }
        timeLeft -= 1000;
        // localStorage.setItem('timeLeft', JSON.stringify(timeLeft));
        // console.log(localStorage.getItem('timeLeft'))
    }

    function startime() {
        myVar = setInterval(startTimer, 1000);
        countDownDate = Date.now() + timeLeft;
    }

    function timerFunction() {
        var timer = document.getElementById("timer");
        var demo = document.getElementById("demo");

        if (timer.classList.contains("timerOn")) {
            demo.style.display = "none";
            timer.classList.remove("timerOn");
        } else {
            demo.style.display = "block";
            timer.classList.add("timerOn");
        }
    }

    function lvlsend(productId, action) {
        console.log("updateStar Fired");
        var url = "/lvltest";
        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({ score: productId, action: action }),
        })
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                console.log("data:", data);
            });
    }

    var apiJson = [];
    var grammarApi = ["api empty"];
    var grammarOutput = [];
    var levelTestSet = [];
    var datalen = 0;
    // function myFunction(item) {
    //   if (item.tag === "Number Agreement") {
    //     grammarOutput.push(item);
    //     const node = document.createElement("li");
    //     const textnode = document.createTextNode(item.tag);
    //     node.appendChild(textnode);
    //     document.getElementById("grammarbox").appendChild(node);
    //   }
    // }

    //////////////////////////////// confirm eligibility to take the test from django side

    var apiGrammar = [];
    var apiContext = [];
    var apiIdiom = [];

    function getGrammar() {
        fetch("https://pertinacity1.pythonanywhere.com/grammarapi")
            .then((resp) => resp.json())
            .then(function (data) {
                // console.log("Grammar Api: ", data);
                grammarApi = data;
                apiJson = data;
                datalen = data.length;

                // for (let i = 0; i < apiJson.length; i++) {
                //   console.log(apiJson[i].correct);
                // }

                // grammarApi.forEach(myFunction);
                //   var randData = apiJson[Math.floor(Math.random() * apiJson.length)];
                //   var rArray = [...Array(datalen).keys()];
                // console.log(rArray.length)

                for (let i = 0; i < datalen; i++) {
                    if (apiJson[i].qtype == "Grammar") {
                        apiGrammar.push(apiJson[i]);
                    } else if (apiJson[i].qtype == "Context") {
                        apiContext.push(apiJson[i]);
                    } else if (apiJson[i].qtype == "Idiom") {
                        apiIdiom.push(apiJson[i]);
                    }
                }

                document.getElementById("grammarbox").innerHTML = "Server Connection: Success.";

                function getRanArr(lngth) {
                    let arr = [];
                    do {
                        let ran = Math.floor(Math.random() * lngth);
                        arr = arr.indexOf(ran) > -1 ? arr : arr.concat(ran);
                    } while (arr.length < lngth);

                    return arr;
                }

                const res = getRanArr(20);
                // var randomnumbers = res.slice(0, 10);
                var randomnumbers = res;

                var idiomLen = 0;
                var contenxtLen = 0;
                var grammarLen = 0;

                for (let i = 0; i < randomnumbers.length; i++) {
                    var rn = randomnumbers[i];

                    if (grammarLen < 10) {
                        levelTestSet.push(apiGrammar[rn]);
                        grammarLen += 1;
                    }
                    if (contenxtLen < 5) {
                        levelTestSet.push(apiContext[rn]);
                        contenxtLen += 1;
                    }
                    if (idiomLen < 5) {
                        levelTestSet.push(apiIdiom[rn]);
                        idiomLen += 1;
                    }
                    if (grammarLen == 10 && contenxtLen == 5 && idiomLen == 5) {
                        break;
                    }
                }

                apiJson = levelTestSet.sort(() => Math.random() - 0.5);
                // console.log(apiJson);

                // for (let i = 0; i < apiJson.length; i++) {
                //   console.log(i, apiJson[i].qtype);
                // }
                updateQuestion();

                // document
                //   .getElementsByClassName("progress-bar")[0]
                //   .setAttribute("style", "width:" + 100 + "%");
                progressPercentage = 100;
                document.getElementById("jsData").innerHTML = "Test is ready. Good Luck!";
                document
                    .getElementById("startBtn")
                    .classList.remove("d-none", "btn-secondary");
                document.getElementById("startBtn").classList.add("btn-outline-warning");
                // document.getElementById("qCount").innerHTML = "Question   " + q + "/" + apiJson.length
                // document.getElementById("qCount").innerHTML = q + "/" + 20 + " id " + currentQuestion.id
            });
    }
    getGrammar();

    // get range of numbers javascript & loop
    // var rArray = ([...Array(60).keys()])
    // for (let i = 0; i < rArray.length; i++) {
    //     console.log(i)
    // }

    var s = document.getElementById("solution");
    var a = document.getElementById("a");
    var b = document.getElementById("b");
    var c = document.getElementById("c");
    var d = document.getElementById("d");

    var qtype = [];

    // var qtype = ["a", "b", "c", "b", "a", "b", "c", "a", "a", "a"];
    // function qtypeCount(array) {
    //   var typeCount = {};
    //   array.forEach((val) => (typeCount[val] = (typeCount[val] || 0) + 1));
    //   return typeCount;
    // }

    // var wrongCount = qtypeCount(qtype);
    // for (const [key, value] of Object.entries(wrongCount)) {
    //   console.log(key, value);
    // }

    function showResults() {
        function qtypeCount(array) {
            var typeCount = {};
            array.forEach((val) => (typeCount[val] = (typeCount[val] || 0) + 1));
            return typeCount;
        }
        var qtypeResult = qtypeCount(qtype);
        console.log(qtypeResult);
        var qtypeGrammar = qtypeResult["Grammar"] * 10;
        var qtypeContext = qtypeResult["Context"] * 20;
        var qtypeIdiom = qtypeResult["Idiom"] * 20;

        document.getElementById("testDiv").classList.add("d-none");
        document.getElementById("resultbox").classList.remove("d-none");

        var percentCorrectBar = correctCount.length * 5;

        if (percentCorrectBar > 80) {
            document
                .getElementsByClassName("progress-bar")[2]
                .setAttribute("style", "width:" + percentCorrectBar + "%");
            document.getElementById("resultpercentagetext").innerHTML =
                percentCorrectBar + "%";
            document.getElementById(
                "resultBox"
            ).innerHTML = `Results : <span class="text-success" >Proficieny PASSED!</span>`;

            //subscore bar
            document
                .getElementsByClassName("progress-bar")[3]
                .setAttribute("style", "width:" + qtypeGrammar + "%");

            document.getElementById("grammarResult").innerHTML = qtypeGrammar + "%";

            document
                .getElementsByClassName("progress-bar")[4]
                .setAttribute("style", "width:" + qtypeContext + "%");

            document.getElementById("contextResult").innerHTML = qtypeContext + "%";

            document
                .getElementsByClassName("progress-bar")[5]
                .setAttribute("style", "width:" + qtypeIdiom + "%");

            document.getElementById("idiomResult").innerHTML = qtypeIdiom + "%";

            fetti();
            //   console.log("fetti fired");
            // setTimeout(function () { window.location.href = 'https://wavecafe.pythonanywhere.com/' }, 6000);
            // $("body").fadeOut(4000, function () { window.location.href = 'https://wavecafe.pythonanywhere.com/' })
        } else {
            document
                .getElementsByClassName("progress-bar")[2]
                .classList.add("bg-danger");

            document
                .getElementsByClassName("progress-bar")[2]
                .setAttribute("style", "width:" + percentCorrectBar + "%");

            document.getElementById("resultpercentagetext").innerHTML =
                percentCorrectBar + "%";
            document.getElementById(
                "resultBox"
            ).innerHTML = `Results : ${percentCorrectBar}% <br> <span class="text-danger h6" >Proficieny FAILED. Passing score is 80% or above. You may request to try again in one week.</span>`;

            //subscore bar
            document
                .getElementsByClassName("progress-bar")[3]
                .setAttribute("style", "width:" + qtypeGrammar + "%");

            document.getElementById("grammarResult").innerHTML = qtypeGrammar + "%";

            document
                .getElementsByClassName("progress-bar")[4]
                .setAttribute("style", "width:" + qtypeContext + "%");

            document.getElementById("contextResult").innerHTML = qtypeContext + "%";

            document
                .getElementsByClassName("progress-bar")[5]
                .setAttribute("style", "width:" + qtypeIdiom + "%");

            document.getElementById("idiomResult").innerHTML = qtypeIdiom + "%";
        }
        lvlsend(percentCorrectBar, "completed");
    }

    function showSolution() {
        s.classList.remove("d-none");
    }
    function hideSolution() {
        s.classList.add("d-none");
    }

    a.addEventListener("click", function () {
        checkAnswer(a);
    });

    b.addEventListener("click", function () {
        checkAnswer(b);
    });

    c.addEventListener("click", function () {
        checkAnswer(c);
    });

    d.addEventListener("click", function () {
        checkAnswer(d);
    });
    // qtype correct divided by X

    var correctCount = [];
    var progressDone = 0;
    var currentQuestion = [];
    var clicked = false;
    function checkAnswer(ans) {
        // console.log(currentQuestion.correct)
        // console.log(ans.dataset.id)

        if (ans.dataset.id === currentQuestion.correct) {
            ans.classList.toggle("bg-success");
            ans.classList.toggle("border-success");
            if (!correctCount.includes(q) && clicked == false) {
                correctCount.push(q);
            }
            clicked = true;
            // console.log(correctCount);
            qtype.push(currentQuestion.qtype);
            document.getElementById("noCorrect").innerHTML =
                correctCount.length + "/" + progressDone;
        } else {
            cA = document.getElementById(correctChoice);
            cA.classList.add("border-success");
            ans.classList.toggle("bg-secondary");
            ans.classList.toggle("border-danger");
            // console.log(correctChoice)
            clicked = true;
            document.getElementById("noCorrect").innerHTML =
                correctCount.length + "/" + progressDone;
        }

        showSolution();
    }

    var choiceA = "A";
    var choiceB = "B";
    var choiceC = "C";
    var choiceD = "D";
    var correctChoice = "X";
    var q = 0;

    var qbox = document.getElementById("question");
    var cQuestion = "";

    function loadQuestion(q) {
        if (q == 20) {
            showResults();
            //endtest // also if time runs out.
            // console.log("fire show results", correctCount.length);
        }

        clicked = false;

        // var randomItem = apiJson[Math.floor(Math.random() * apiJson.length)];
        var randomItem = apiJson[q];

        currentQuestion = randomItem;
        choiceA = randomItem.choice1;
        choiceB = randomItem.choice2;
        choiceC = randomItem.choice3;
        choiceD = randomItem.choice4;
        qbox.innerHTML = randomItem.question;
        cQuestion = randomItem.question;
        document.getElementById("a").innerHTML = "A.   " + randomItem.choice1;
        document.getElementById("b").innerHTML = "B.   " + randomItem.choice2;
        document.getElementById("c").innerHTML = "C.   " + randomItem.choice3;
        document.getElementById("d").innerHTML = "D.   " + randomItem.choice4;
        a.dataset.id = randomItem.choice1;
        b.dataset.id = randomItem.choice2;
        c.dataset.id = randomItem.choice3;
        d.dataset.id = randomItem.choice4;
        if (randomItem.choice1 === randomItem.correct) {
            correctChoice = "a";
        } else if (randomItem.choice2 === randomItem.correct) {
            correctChoice = "b";
        } else if (randomItem.choice3 === randomItem.correct) {
            correctChoice = "c";
        } else if (randomItem.choice4 === randomItem.correct) {
            correctChoice = "d";
        }
        document.getElementById("solution").innerHTML =
            "Solution: " +
            randomItem.solution +
            `<h6 class="text-primary my-3  ">


        <a href="/wistia.html" class="text-decoration-none" >${randomItem.tag}</a>


        </h6>`;
        document.getElementById("qCount").innerHTML =
            q +
            1 +
            "/" +
            20;
    }
    // loadQuestion(q)
    document.getElementById("next").addEventListener("click", updateQuestion);

    function updateQuestion() {
        progressDone += 5;
        document
            .getElementsByClassName("progress-bar")[1]
            .setAttribute("style", "width:" + progressDone + "%");

        a.classList.remove(
            "bg-success",
            "border-success",
            "bg-secondary",
            "border-secondary",
            "border-danger"
        );
        b.classList.remove(
            "bg-success",
            "border-success",
            "bg-secondary",
            "border-secondary",
            "border-danger"
        );
        c.classList.remove(
            "bg-success",
            "border-success",
            "bg-secondary",
            "border-secondary",
            "border-danger"
        );
        d.classList.remove(
            "bg-success",
            "border-success",
            "bg-secondary",
            "border-secondary",
            "border-danger"
        );
        hideSolution();
        loadQuestion(q);
        q += 1;
    }

    // Init SpeechSynth API
    const synth = window.speechSynthesis;

    // DOM Elements

    const textInput = document.querySelector("#question");
    const readBtn = document.querySelector("#read");

    //Browser identifier
    // Firefox 1.0+
    var isFirefox = typeof InstallTrigger !== "undefined";

    // Chrome 1+
    var isChrome = !!window.chrome && !!window.chrome.webstore;

    // Init voices array
    let voices = [];

    const getVoices = () => {
        voices = synth.getVoices();

        // Loop through voices and create an option for each one
        voices.forEach((voice) => {
            // Create option element
            const option = document.createElement("option");
            // Fill option with voice and language
            option.textContent = voice.name + "(" + voice.lang + ")";

            // Set needed option attributes
            option.setAttribute("data-lang", voice.lang);
            option.setAttribute("data-name", voice.name);
        });
    };

    //Line 35, 36 causes voice list duplication
    getVoices();
    if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = getVoices;
    }

    //Fix for duplication, run code depending on the browser
    if (isFirefox) {
        getVoices();
    }
    if (isChrome) {
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = getVoices;
        }
    }

    // Speak
    const speak = () => {
        // Check if speaking
        if (synth.speaking) {
            console.error("Already speaking...");
            return;
        }
        if (textInput.value !== "") {
            // Get speak text
            const speakText = new SpeechSynthesisUtterance(cQuestion);

            // Speak end
            speakText.onend = (e) => {
                console.log("Done reading...");
            };

            // Speak error
            speakText.onerror = (e) => {
                console.error("Something went wrong");
            };

            // Speak
            synth.speak(speakText);
        }
    };

    // EVENT LISTENERS

    // Text form submit
    readBtn.addEventListener("click", (e) => {
        e.preventDefault();
        speak();
    });

    function fetti() {
        // If set to true, the user must press
        // UP UP DOWN ODWN LEFT RIGHT LEFT RIGHT A B
        // to trigger the confetti with a random color theme.
        // Otherwise the confetti constantly falls.
        var onlyOnKonami = false;

        $(function () {
            // Globals
            var $window = $(window),
                random = Math.random,
                cos = Math.cos,
                sin = Math.sin,
                PI = Math.PI,
                PI2 = PI * 2,
                timer = undefined,
                frame = undefined,
                confetti = [];

            var runFor = 5000;
            var isRunning = true;

            setTimeout(() => {
                isRunning = false;
            }, runFor);

            // Settings
            var konami = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65],
                pointer = 0;

            var particles = 150,
                spread = 20,
                sizeMin = 5,
                sizeMax = 12 - sizeMin,
                eccentricity = 10,
                deviation = 100,
                dxThetaMin = -0.1,
                dxThetaMax = -dxThetaMin - dxThetaMin,
                dyMin = 0.13,
                dyMax = 0.18,
                dThetaMin = 0.4,
                dThetaMax = 0.7 - dThetaMin;

            var colorThemes = [
                function () {
                    return color(
                        (200 * random()) | 0,
                        (200 * random()) | 0,
                        (200 * random()) | 0
                    );
                },
                function () {
                    var black = (200 * random()) | 0;
                    return color(200, black, black);
                },
                function () {
                    var black = (200 * random()) | 0;
                    return color(black, 200, black);
                },
                function () {
                    var black = (200 * random()) | 0;
                    return color(black, black, 200);
                },
                function () {
                    return color(200, 100, (200 * random()) | 0);
                },
                function () {
                    return color((200 * random()) | 0, 200, 200);
                },
                function () {
                    var black = (256 * random()) | 0;
                    return color(black, black, black);
                },
                function () {
                    return colorThemes[random() < 0.5 ? 1 : 2]();
                },
                function () {
                    return colorThemes[random() < 0.5 ? 3 : 5]();
                },
                function () {
                    return colorThemes[random() < 0.5 ? 2 : 4]();
                },
            ];
            function color(r, g, b) {
                return "rgb(" + r + "," + g + "," + b + ")";
            }

            // Cosine interpolation
            function interpolation(a, b, t) {
                return ((1 - cos(PI * t)) / 2) * (b - a) + a;
            }

            // Create a 1D Maximal Poisson Disc over [0, 1]
            var radius = 1 / eccentricity,
                radius2 = radius + radius;
            function createPoisson() {
                // domain is the set of points which are still available to pick from
                // D = union{ [d_i, d_i+1] | i is even }
                var domain = [radius, 1 - radius],
                    measure = 1 - radius2,
                    spline = [0, 1];
                while (measure) {
                    var dart = measure * random(),
                        i,
                        l,
                        interval,
                        a,
                        b,
                        c,
                        d;

                    // Find where dart lies
                    for (i = 0, l = domain.length, measure = 0; i < l; i += 2) {
                        (a = domain[i]), (b = domain[i + 1]), (interval = b - a);
                        if (dart < measure + interval) {
                            spline.push((dart += a - measure));
                            break;
                        }
                        measure += interval;
                    }
                    (c = dart - radius), (d = dart + radius);

                    // Update the domain
                    for (i = domain.length - 1; i > 0; i -= 2) {
                        (l = i - 1), (a = domain[l]), (b = domain[i]);
                        // c---d          c---d  Do nothing
                        //   c-----d  c-----d    Move interior
                        //   c--------------d    Delete interval
                        //         c--d          Split interval
                        //       a------b
                        if (a >= c && a < d)
                            if (b > d) domain[l] = d; // Move interior (Left case)
                            else domain.splice(l, 2);
                        // Delete interval
                        else if (a < c && b > c)
                            if (b <= d) domain[i] = c; // Move interior (Right case)
                            else domain.splice(i, 0, c, d); // Split interval
                    }

                    // Re-measure the domain
                    for (i = 0, l = domain.length, measure = 0; i < l; i += 2)
                        measure += domain[i + 1] - domain[i];
                }

                return spline.sort();
            }

            // Create the overarching container
            var container = document.createElement("div");
            container.style.position = "fixed";
            container.style.top = "0";
            container.style.left = "0";
            container.style.width = "100%";
            container.style.height = "0";
            container.style.overflow = "visible";
            container.style.zIndex = "9999";

            // Confetto constructor
            function Confetto(theme) {
                this.frame = 0;
                this.outer = document.createElement("div");
                this.inner = document.createElement("div");
                this.outer.appendChild(this.inner);

                var outerStyle = this.outer.style,
                    innerStyle = this.inner.style;
                outerStyle.position = "absolute";
                outerStyle.width = sizeMin + sizeMax * random() + "px";
                outerStyle.height = sizeMin + sizeMax * random() + "px";
                innerStyle.width = "100%";
                innerStyle.height = "100%";
                innerStyle.backgroundColor = theme();

                outerStyle.perspective = "50px";
                outerStyle.transform = "rotate(" + 360 * random() + "deg)";
                this.axis =
                    "rotate3D(" + cos(360 * random()) + "," + cos(360 * random()) + ",0,";
                this.theta = 360 * random();
                this.dTheta = dThetaMin + dThetaMax * random();
                innerStyle.transform = this.axis + this.theta + "deg)";

                this.x = $window.width() * random();
                this.y = -deviation;
                this.dx = sin(dxThetaMin + dxThetaMax * random());
                this.dy = dyMin + dyMax * random();
                outerStyle.left = this.x + "px";
                outerStyle.top = this.y + "px";

                // Create the periodic spline
                this.splineX = createPoisson();
                this.splineY = [];
                for (var i = 1, l = this.splineX.length - 1; i < l; ++i)
                    this.splineY[i] = deviation * random();
                this.splineY[0] = this.splineY[l] = deviation * random();

                this.update = function (height, delta) {
                    this.frame += delta;
                    this.x += this.dx * delta;
                    this.y += this.dy * delta;
                    this.theta += this.dTheta * delta;

                    // Compute spline and convert to polar
                    var phi = (this.frame % 7777) / 7777,
                        i = 0,
                        j = 1;
                    while (phi >= this.splineX[j]) i = j++;
                    var rho = interpolation(
                        this.splineY[i],
                        this.splineY[j],
                        (phi - this.splineX[i]) / (this.splineX[j] - this.splineX[i])
                    );
                    phi *= PI2;

                    outerStyle.left = this.x + rho * cos(phi) + "px";
                    outerStyle.top = this.y + rho * sin(phi) + "px";
                    innerStyle.transform = this.axis + this.theta + "deg)";
                    return this.y > height + deviation;
                };
            }

            function poof() {
                if (!frame) {
                    // Append the container
                    document.body.appendChild(container);

                    // Add confetti

                    var theme =
                        colorThemes[onlyOnKonami ? (colorThemes.length * random()) | 0 : 0],
                        count = 0;

                    (function addConfetto() {
                        if (onlyOnKonami && ++count > particles) return (timer = undefined);

                        if (isRunning) {
                            var confetto = new Confetto(theme);
                            confetti.push(confetto);

                            container.appendChild(confetto.outer);
                            timer = setTimeout(addConfetto, spread * random());
                        }
                    })(0);

                    // Start the loop
                    var prev = undefined;
                    requestAnimationFrame(function loop(timestamp) {
                        var delta = prev ? timestamp - prev : 0;
                        prev = timestamp;
                        var height = $window.height();

                        for (var i = confetti.length - 1; i >= 0; --i) {
                            if (confetti[i].update(height, delta)) {
                                container.removeChild(confetti[i].outer);
                                confetti.splice(i, 1);
                            }
                        }

                        if (timer || confetti.length)
                            return (frame = requestAnimationFrame(loop));

                        // Cleanup
                        document.body.removeChild(container);
                        frame = undefined;
                    });
                }
            }

            $window.keydown(function (event) {
                pointer =
                    konami[pointer] === event.which
                        ? pointer + 1
                        : +(event.which === konami[0]);
                if (pointer === konami.length) {
                    pointer = 0;
                    poof();
                }
            });

            if (!onlyOnKonami) poof();
        });
    }



</script>

</html>